<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CamStem</title>
  <style>
    /* 
      1) Full-screen gradient background, remove scrollbars, 
         and white text for contrast 
    */
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #003554, #051923) no-repeat center center fixed;
      background-size: cover;
      color: #ffffff;
      overflow: hidden; /* remove scrollbars on the entire page */
    }

    /* Optionally remove scrollbar track in WebKit browsers */
    ::-webkit-scrollbar {
      width: 0px;
      background: transparent;
    }

    /* 
      2) A container with a translucent background, 
         centered horizontally, with rounded corners.
    */
    .container {
      max-width: 600px;
      margin: 2rem auto;
      background-color: rgba(255, 255, 255, 0.07);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Title styling */
    h1 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    /* Progress Bar Container + label */
    .progress-container {
      position: relative;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      width: 100%;
      height: 20px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #28a745; /* green */
      transition: width 0.4s ease;
    }
    .progress-label {
      position: absolute;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
      color: #ffffff;
      font-weight: bold;
      line-height: 20px;
      pointer-events: none;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    /* Labels for inputs */
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    /* Inputs & selects with a translucent background, 
       full width, border radius, etc. */
    input[type="text"],
    select {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      box-sizing: border-box;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      background-color: rgba(255,255,255,0.15);
      color: #ffffff;
      outline: none;
    }

    /* Buttons with a slight hover effect */
    button {
      margin-top: 10px;
      padding: 8px 14px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background-color: #006494;
      color: #ffffff;
      transition: background-color 0.3s, transform 0.3s;
    }
    button:hover {
      background-color: #004a66;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Scrollable logs area */
    #status {
      margin-top: 10px;
      font-weight: bold;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto; /* make logs scrollable */
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      padding: 8px;
      background-color: rgba(255,255,255,0.1);
    }

    /* Hide the "Check Audio" button visually, 
       but keep it in the DOM for your JS references */
    #checkAudioBtn {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Title -->
    <h1>CamStem</h1>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
      <div class="progress-label" id="progressLabel">0%</div>
    </div>

    <!-- Path to Process -->
    <label for="demucsPath">Path to Process:</label>
    <input
      type="text"
      id="demucsPath"
      placeholder="e.g. C:\Program Files\CamStem\demucs-cxfreeze.exe"
    />

    <!-- Assets Path -->
    <label for="modelDir">Assets Path:</label>
    <input
      type="text"
      id="modelDir"
      placeholder="e.g. F:\Project-CamStem\Models"
    />

    <!-- Select Model -->
    <label for="modelSelect">Select Model:</label>
    <select id="modelSelect">
      <option value="htdemucs">Default 4-Stem (htdemucs)</option>
      <option value="htdemucs_ft">High Quality 4-Stem (htdemucs_ft)</option>
      <option value="htdemucs_6s">Experimental 6-Stem (htdemucs_6s)</option>
    </select>

    <!-- Quality Preset -->
    <label for="qualitySelect">Quality Preset (lower is better quality)</label>
    <select id="qualitySelect">
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4" selected>4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
    </select>

    <!-- Hidden checkAudioBtn to avoid breaking old logic -->
    <button id="checkAudioBtn">Check Audio</button>

    <!-- Save, Split, Place buttons (IDs unchanged) -->
    <button id="savePathBtn">Save Settings</button>
    <button id="splitAudioBtn">Split Audio</button>
    <button id="placeStemsBtn">Place Stems On Timeline</button>

    <!-- Scrollable status/logs -->
    <div id="status"></div>
  </div>

  <!-- Adobe CEP + Your Scripts -->
  <script src="CSInterface.js"></script>

  <script>
    /***************************************************************************
     * Revert to simpler single-stage approach with:
     *   - handleDemucsLog(newChunk)
     *   - parse lines for "0%|", "NN%|", "100%|"
     *   - show messages "Initializing...", "Creating Files...", "Done!"
     *   - logs appended to #status
     ***************************************************************************/
    let demucsOutputBuffer = "";
    let statusEl, progressBarEl, progressLabelEl;

    window.addEventListener("load", function() {
      statusEl       = document.getElementById("status");
      progressBarEl  = document.getElementById("progressBar");
      progressLabelEl= document.getElementById("progressLabel");
      
      // For demonstration, let's simulate logs. 
      // In real usage, your index.js spawns Demucs, then calls handleDemucsLog(...)
      const simulatedLogs = [
        "[JS] Checking selected audio...",
        "[JS] => Found inputAudio = something.mp3",
        "Selected model is a bag of 1 models. You will see that many progress bars per track.",
        "Separated tracks will be stored in C:/some/folder",
        "Separating track C:/some/folder/something.mp3",
        "[ERR]  0%|   0.0/193.04 [00:00<?, ?seconds/s]",
        "[ERR]  25%|###   48.2/193.04 [00:01<00:06, 23.6seconds/s]",
        "[ERR]  50%|#####  96.5/193.04 [00:02<00:03, 30.0seconds/s]",
        "[ERR]  100%|#######| 193.04/193.04 [00:04<00:00, 40.0seconds/s]",
        "[JS] Demucs exited with code 0",
        "Done!"
      ];
      let idx = 0;
      let demoTimer = setInterval(() => {
        if (idx < simulatedLogs.length) {
          handleDemucsLog(simulatedLogs[idx] + "\\n");
          idx++;
        } else {
          clearInterval(demoTimer);
        }
      }, 1200);
    });

    /***************************************************************************
     * handleDemucsLog(newChunk)
     *  - Called from your Node child_process stdout & stderr events
     ***************************************************************************/
    function handleDemucsLog(newChunk) {
      demucsOutputBuffer += newChunk;
      const lines = demucsOutputBuffer.split(/\r?\n/);
      demucsOutputBuffer = lines.pop(); // leftover partial line
      lines.forEach(parseDemucsLine);
    }

    function parseDemucsLine(line) {
      // 1) Always append raw line to the #status text
      statusEl.textContent += line + "\\n";

      // 2) Check for 0% => "Initializing..."
      if (line.match(/\b0%?\|/)) {
        setProgress(0);
        progressLabelEl.textContent = "Initializing...";
      }

      // 3) Check for 100% => "Creating Files..."
      else if (line.match(/\b100%?\|/)) {
        setProgress(100);
        progressLabelEl.textContent = "Creating Files - This May Take a Moment";
      }

      // 4) Else check for e.g. 17%| or 83%|
      else {
        // Could match lines like " 17%|####..."
        const match = line.match(/\b(\d{1,3})%\|/);
        if (match) {
          let pct = parseInt(match[1], 10);
          if (pct < 0) pct = 0;
          if (pct > 100) pct = 100;
          setProgress(pct);
          progressLabelEl.textContent = pct + "%";
        }
      }

      // 5) If line includes "Demucs exited with code 0", we consider it done
      if (line.includes("Demucs exited with code 0")) {
        // If we've not seen 100% yet, let's set 100
        setProgress(100);
        progressLabelEl.textContent = "Separation Completed";
      }
    }

    // Helper to update the bar
    function setProgress(pct) {
      progressBarEl.style.width = pct + "%";
      if (pct === 0) {
        progressLabelEl.textContent = "0%";
      } else if (pct === 100) {
        progressLabelEl.textContent = "100%";
      }
    }
  </script>

  <script src="index.js"></script>
</body>
</html>
